name: Security Pipeline  # CORREGIT
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # CANVIA @v3 per @v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest selenium
        
    - name: Run unit tests
      run: |
        echo "Executant tests unitaris..."
        python -m pytest test_vault.py -v
      continue-on-error: false

  security-scan:  # AFEGEIX AQUEST JOB QUE ET FALTA
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Chrome and ChromeDriver
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        CHROME_VERSION=$(google-chrome --version | cut -d' ' -f3 | cut -d'.' -f1)
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
        wget -q "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        chmod +x /usr/local/bin/chromedriver
    
    - name: Install Python dependencies
      run: |
        pip install selenium
    
    - name: Run security scan (attack bot)
      id: security-scan
      run: |
        echo "Executant escaneig de seguretat..."
        
        cat > attack_bot_ci.py << 'EOF'
        from selenium import webdriver
        from selenium.webdriver.common.by import By
        from selenium.webdriver.chrome.options import Options
        import time
        import sys
        
        chrome_options = Options()
        chrome_options.add_argument("--headless")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        
        passwords = ['1234', 'qwerty', 'admin', 'password123', 'letmein']
        
        try:
            driver = webdriver.Chrome(options=chrome_options)
            
            import os
            html_path = os.path.join(os.getcwd(), 'login.html')
            
            if not os.path.exists(html_path):
                print("ERROR: No es troba login.html")
                sys.exit(0)
            
            driver.get(f"file://{html_path}")
            time.sleep(2)
            
            driver.find_element(By.ID, 'username').send_keys('admin')
            
            print("Iniciant atac de forÃ§a bruta...")
            print("="*50)
            
            for pwd in passwords:
                print(f"Provant contrasenya: '{pwd}'")
                
                driver.find_element(By.ID, 'password').clear()
                driver.find_element(By.ID, 'password').send_keys(pwd)
                driver.find_element(By.ID, 'loginBtn').click()
                time.sleep(1)
                
                message = driver.find_element(By.ID, 'message').text
                
                if "ACCESS_GRANTED" in message:
                    print(f"ðŸš¨ VULNERABILITAT TROBADA!")
                    print(f"Contrasenya vulnerable: '{pwd}'")
                    print("="*50)
                    driver.save_screenshot('vulnerability_found.png')
                    driver.quit()
                    sys.exit(1)
                else:
                    print(f"âœ“ Resistit a contrasenya: '{pwd}'")
            
            print("="*50)
            print("âœ… Escaneig completat: Cap vulnerabilitat trobada")
            driver.quit()
            sys.exit(0)
            
        except Exception as e:
            print(f"Error durant l'escaneig: {e}")
            sys.exit(0)
        EOF
        
        python attack_bot_ci.py
        
    - name: Upload security evidence
      if: failure() && steps.security-scan.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: security-evidence
        path: |
          vulnerability_found.png
          attack_bot_ci.py

